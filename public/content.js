function waitForElm(e){return new Promise((t=>{if(document.querySelector(e))return t(document.querySelector(e));const r=new MutationObserver((o=>{document.querySelector(e)&&(t(document.querySelector(e)),r.disconnect())}));r.observe(document.body,{childList:!0,subtree:!0})}))}function updateCurrentOpenings(e){const t=`https://explorer.lichess.ovh/masters?fen=${encodeURIComponent(e)}`;console.log(`Loading openings for ${e}`),fetch(t).then((t=>{if(!t.ok)throw new Error(`Network response was not ok. fen: ${e}`);return t.json()})).then((t=>{t.color=e.split(" ")[1],t.moves=t.moves.filter((e=>e.black+e.white+e.draws>=0)),t.opening?last_opening_name=t.opening.name:last_opening_name&&(t.opening={name:last_opening_name}),t.moves.length>0?chrome.storage.local.set({openings:t}):chrome.storage.local.set({openings:null})})).catch((e=>{console.error("There was a problem with the fetch operation:",e),chrome.storage.local.set({openings:null})}))}function parsePiecePosition(e){const t=e.split(" ");let r=t.find((e=>2==e.length));const o=t.find((e=>e.startsWith("square")));return r=r.startsWith("w")?r[1].toUpperCase():r[1].toLowerCase(),{type:r,row:7-parseInt(o.split("-")[1][1]-1),col:parseInt(o.split("-")[1][0]-1),color:r==r.toUpperCase()?"w":"b"}}function getPiecePositionMatrix(){const e=$.makeArray($('wc-chess-board > div[class^="piece"]')),t=[...Array(8)].map((e=>Array(8).fill(0)));return e.map((e=>{p=parsePiecePosition(e.className),t[p.row][p.col]=p.type})),t}function getFENCastlingString(){const e=getPiecePositionMatrix();return options="","K"==e[7][4]&&("R"==e[7][7]&&(options+="K"),"R"==e[7][0]&&(options+="Q")),"k"==e[0][4]&&("r"==e[0][7]&&(options+="k"),"r"==e[0][0]&&(options+="q")),""!=options?options:"-"}function getStartingFenString(){return"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"}function getFENString(e=null){null==e&&(e=getPlayerColor());const t=getPiecePositionMatrix(),r=[];let o=0;for(i=0;i<8;i++){let e="";for(j=0;j<8;j++)0==t[i][j]?o+=1:(o>0&&(e+=o.toString(),o=0),e+=t[i][j]);o>0&&(e+=o.toString(),o=0),r.push(e)}let s=r.join("/");return s+=` ${e}`,s+=` ${getFENCastlingString()}`,s+=" - 0 1",s}function clearMoveHighlights(){document.querySelectorAll("wc-chess-board > div.effect").forEach((e=>e.remove())),$('wc-chess-board > div[id="move-highlight"]').remove()}function clearOpenBookMoveHighlights(){$('wc-chess-board > div[move_type="open-book"]').remove()}function isOpenBookMoveHighlighted(){return $('wc-chess-board > div[move_type="open-book"]').length>0}function isEngineMoveHighlighted(){return $('wc-chess-board > div[move_type="engine"]').length>0}function _highlightMove(e,t,r){clearMoveHighlights();const o=["a","b","c","d","e","f","g","h"],i=o.indexOf(e[0])+1,s=o.indexOf(e[2])+1;document.querySelectorAll("wc-chess-board > div.effect").forEach((e=>e.remove())),$(`wc-chess-board > div[class="effect square-${s+e[1]}"]`).remove();let n=`<div move_type="${r}" id="move-highlight" class="highlight square-${i+e[1]}" style="background-color: ${t}; opacity: 0.60;"></div>`;$("wc-chess-board").prepend(n),$(`wc-chess-board > div[class="highlight square-${s+e[3]}"]`).remove(),n=`<div move_type="${r}" id="move-highlight" class="highlight square-${s+e[3]}" style="background-color: ${t}; opacity: 0.80"></div>`,$("wc-chess-board").prepend(n);let l=`<div class="effect square-${s+e[3]}"> \n  <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="eGeT3fwtQRB1" viewBox="0 0 18 19" shape-rendering="geometricPrecision" text-rendering="geometricPrecision"><defs><filter id="eGeT3fwtQRB16-filter" x="-150%" width="400%" y="-150%" height="400%"><feGaussianBlur id="eGeT3fwtQRB16-filter-drop-shadow-0-blur" in="SourceAlpha" stdDeviation="0,0"/><feOffset id="eGeT3fwtQRB16-filter-drop-shadow-0-offset" dx="0" dy="0" result="tmp"/><feFlood id="eGeT3fwtQRB16-filter-drop-shadow-0-flood" flood-color="#b3b3b3"/><feComposite id="eGeT3fwtQRB16-filter-drop-shadow-0-composite" operator="in" in2="tmp"/><feMerge id="eGeT3fwtQRB16-filter-drop-shadow-0-merge"><feMergeNode id="eGeT3fwtQRB16-filter-drop-shadow-0-merge-node-1"/><feMergeNode id="eGeT3fwtQRB16-filter-drop-shadow-0-merge-node-2" in="SourceGraphic"/></feMerge></filter></defs><g><path d="M9,0.5c-4.970563,0-9,4.029437-9,9s4.029437,9,9,9s9-4.029437,9-9-4.029437-9-9-9Z" opacity="0.3"/><path d="M9,0C4.029437,0,0,4.029437,0,9s4.029437,9,9,9s9-4.029437,9-9-4.029437-9-9-9Z" fill="#a0c852"/><g transform="translate(0 1.177635)"><rect width="8.410435" height="8.03782" rx="1" ry="1" transform="translate(4.794783 5.48109)" fill="#b3b3b3" stroke-width="0"/><rect width="1.8" height="1.9" rx="0" ry="0" transform="matrix(.578433 0 0 1.379415 8.479411 4.170646)" fill="#b3b3b3" stroke-width="0"/><rect width="1.8" height="1.9" rx="0.9" ry="0.9" transform="matrix(.578433 0 0 1.379415 12.684628 7.499999)" fill="#b3b3b3" stroke-width="0"/><rect width="1.8" height="1.9" rx="0.9" ry="0.9" transform="matrix(.578433 0 0 1.379415 4.274193 7.499999)" fill="#b3b3b3" stroke-width="0"/><ellipse rx="1.206172" ry="1.066864" transform="matrix(1 0 0 1.146637 9.000001 3.845671)" fill="#b3b3b3" stroke-width="0"/><ellipse rx="1.206172" ry="1.066864" transform="matrix(1 0 0 1.146637 9.000001 3.845671)" fill="#b3b3b3" stroke-width="0"/><ellipse rx="0.75" ry="0.654087" transform="matrix(1 0 0 1.146637 9 3.845672)" fill="#b3b3b3" stroke-width="0"/><ellipse rx="0.75" ry="0.654087" transform="matrix(1 0 0 1.146637 7.043829 8.25)" fill="#b3b3b3" stroke-width="0"/><ellipse rx="0.75" ry="0.654087" transform="matrix(1 0 0 1.146637 10.956173 8.25)" fill="#b3b3b3" stroke-width="0"/><ellipse rx="1.956172" ry="0.73586" transform="matrix(1 0 0 0.499356 9.000001 11.732797)" fill="#b3b3b3" stroke-width="0"/></g></g><g transform="translate(0 0.929363)" filter="url(#eGeT3fwtQRB16-filter)"><rect width="8.410435" height="8.03782" rx="1" ry="1" transform="translate(4.794783 5.48109)" fill="#fff" stroke-width="0"/><rect width="1.8" height="1.9" rx="0" ry="0" transform="matrix(.578433 0 0 1.379415 8.479411 4.170646)" fill="#fff" stroke-width="0"/><rect width="1.8" height="1.9" rx="0.9" ry="0.9" transform="matrix(.578433 0 0 1.379415 12.684628 7.499999)" fill="#fff" stroke-width="0"/><rect width="1.8" height="1.9" rx="0.9" ry="0.9" transform="matrix(.578433 0 0 1.379415 4.274193 7.499999)" fill="#fff" stroke-width="0"/><ellipse rx="1.206172" ry="1.066864" transform="matrix(1 0 0 1.146637 9.000001 3.845671)" fill="#fff" stroke-width="0"/><ellipse rx="1.206172" ry="1.066864" transform="matrix(1 0 0 1.146637 9.000001 3.845671)" fill="#fff" stroke-width="0"/><ellipse rx="0.75" ry="0.654087" transform="matrix(1 0 0 1.146637 9 3.845672)" fill="#a0c852" stroke-width="0"/><ellipse rx="0.75" ry="0.654087" transform="matrix(1 0 0 1.146637 7.043829 8.25)" fill="#a0c852" stroke-width="0"/><ellipse rx="0.75" ry="0.654087" transform="matrix(1 0 0 1.146637 10.956173 8.25)" fill="#a0c852" stroke-width="0"/><ellipse rx="1.956172" ry="0.73586" transform="matrix(1 0 0 0.499356 9.000001 11.732797)" fill="#a0c852" stroke-width="0"/></g></svg>\n  </div>`;$("wc-chess-board").prepend(l),$('wc-chess-board > div[class="effect square-${col2 + move[1]}"]').fadeIn()}function highlightMove(e,t="engine"){"engine"==t?chrome.storage.local.get(["engineColor"],(r=>{_highlightMove(e,r.engineColor,t)})):"open-book"==t&&_highlightMove(e,color="rgb(235, 97, 80)",t)}function isNewGame(){const e=getPiecePositionMatrix();for(i=0;i<8;i++){for(j=0;j<2;j++)if(0==e[j][i])return!1;for(j=6;j<8;j++)if(0==e[j][i])return!1}return!0}function getPlayerColor(){return document.querySelector("wc-chess-board").className.includes("flipped")?"b":"w"}function getOpponentColor(){return"w"==getPlayerColor()?"b":"w"}function storePlayerColor(){const e=getPlayerColor();chrome.storage.local.set({player_color:e})}function newGameReset(){console.log("New Game!"),storePlayerColor(),clearMoveHighlights(),last_opening_name=null,chrome.storage.local.set({solver_result:null}),chrome.runtime.sendMessage({type:"newGame",fen_string:getFENString()}),"w"==getPlayerColor()&&chrome.runtime.sendMessage({type:"startSolve",fen_string:getFENString()}),updateCurrentOpenings(getStartingFenString())}function isPieceClassName(e){const t=e.split(" ");if(3!=t.length)return!1;const r=t.find((e=>2==e.length)),o=t.find((e=>e.startsWith("square")));return null!=r&&null!=o}function attachPieceObserverToBoard(){const e=new MutationObserver((e=>{e.some((e=>("board"==e.oldValue||"board-flipped"==e.oldValue)&&e.target.className!=e.oldValue))&&newGameReset();const t=e.filter((e=>isPieceClassName(e.oldValue)&&isPieceClassName(e.target.className)));t.length>0&&(console.log("Move detected!"),document.querySelectorAll("wc-chess-board > div.effect").forEach((e=>e.remove())),isNewGame()?newGameReset():(storePlayerColor(),clearMoveHighlights(),p_new=parsePiecePosition(t[0].target.className),p_new.color!=getPlayerColor()?setTimeout((()=>{chrome.runtime.sendMessage({type:"startSolve",fen_string:getFENString()}),updateCurrentOpenings(getFENString())}),300):(setTimeout((()=>{updateCurrentOpenings(getFENString(getOpponentColor()))}),300),chrome.runtime.sendMessage({type:"stopSolve"}))))})),t=document.querySelector("wc-chess-board");e.observe(t,{attributes:!0,subtree:!0,attributeOldValue:!0,attributeFilter:["class"]})}function main(){newGameReset(),attachPieceObserverToBoard()}last_opening_name=null,waitForElm("wc-chess-board").then((e=>{console.log("Board is loaded!"),main()})),chrome.runtime.onMessage.addListener(((e,t,r)=>{switch(e.type){case"isBoardPresent":r({isBoardPresent:!0});break;case"highlightBookMove":console.log(`Highlighting book move: ${e.move}`),highlightMove(e.move,move_type="open-book"),r({});break;case"unhighlightBookMove":clearOpenBookMoveHighlights(),console.log("unhighlighting book move"),chrome.storage.local.get(["solver_result","enabled"],(e=>{e.solver_result&&e.enabled&&e.solver_result.fen==getFENString()&&highlightMove(e.solver_result.best_move)})),r({})}})),chrome.storage.onChanged.addListener(((e,t)=>{"solver_result"in e&&void 0!==e.solver_result&&void 0!==e.solver_result.newValue&&chrome.storage.local.get(["enabled"],(t=>{!t.enabled||isEngineMoveHighlighted()&&e.solver_result.newValue.best_move==e.solver_result.oldValue.best_move||isOpenBookMoveHighlighted()||e.solver_result.newValue.fen!=getFENString()||(console.log(`Best engine move: ${e.solver_result.newValue.best_move}`),highlightMove(e.solver_result.newValue.best_move))}))})),chrome.storage.onChanged.addListener(((e,t)=>{"enabled"in e&&0==e.enabled.newValue?clearMoveHighlights():"enabled"in e&&1==e.enabled.newValue&&chrome.runtime.sendMessage({type:"startSolve",fen_string:getFENString()})})),$(document).keypress((e=>{"KeyE"==e.code&&chrome.storage.local.get(["enabled"],(e=>{chrome.storage.local.set({enabled:!e.enabled})}))}));